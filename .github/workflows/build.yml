name: build
on:
  push:
  pull_request:
    branches:
      - main
    types: # don't run build for Draft PRs
      - opened
      - reopened
      - synchronize
      - ready_for_review
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      DEBUG: 'true'
      DEBIAN_FRONTEND: noninteractive
      NETCDF_RELEASE: https://api.github.com/repos/Unidata/netcdf-fortran/releases/latest
      LD_LIBRARY_PATH: /usr/lib/
    steps:
      - uses: actions/checkout@v4
      - name: Install libnetcdf
        run: |
          sudo apt update -y && sudo apt install -y --no-install-recommends \
            hdf5-tools hdf5-helpers libhdf5-dev libhdf5-serial-dev libnetcdf-dev
      - name: Install gfortran and mpifort
        run: sudo apt install -y --no-install-recommends gfortran mpich libmpich-dev 
      - name: Install netcdf4-fortran
        run: |
          export NETCDF_URL=$(curl "$NETCDF_RELEASE" | jq -r '.tarball_url')
          echo "Fetching: $NETCDF_URL"
          curl -L "$NETCDF_URL" --output netcdf.tar.gz
          tar -xf netcdf.tar.gz
          cd Unidata-netcdf*
          ./configure && make && sudo make install
          nf-config --all
      - name: Build
        run: NETCDF4_LIB=$(nc-config --flibs) NETCDF4_INCLUDE=$(nc-config --fflags) make
